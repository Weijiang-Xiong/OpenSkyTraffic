## How to generate and preprocess Simbarca data

### Metadata: network structure

To obtain metadata from Aimsun

1. Open Aimsun and open the network model for barcelona
2. In the project tree on the right, navigate to Scripts, right click to create a new empty script
3. Open the new script, copy read_road_graph.py and paste to the script section under aimsun project window.
4. Click `execute` at the bottom and then OK.

The road segments need to be clustered and assigned to grids for regional prediction and drone flight scheduling. 

```
python scripts/data/simbarca/group_selection.py
```

### Vehicle trajectory data

#### Experiment settings

The simulation experiments will be run with different random seeds, and random augmentations will be applied to the traffic demand.

These randomness settings are generated by

```
python scripts/data/simbarca/gen_exp_settings.py 
```

#### Aimsun API

The vehicle trajectories are exported using `Aimsun_API.py` please add it to the simulation in Aimsun.

Go to project panel, expand scenarios and then double click a scenario, select Aimsun Next APIs, and click `Add` and OK.

If the API file is moved, the path settings in aimsun should also be changed.

#### From trajectory to training data

First, the trajectories (positions over time) will be used to compute initial statistics for all sections (road segments) at each time step.

```
python scripts/data/simbarca/time_series_from_traj.py
```

Please look at the script comments for details.

Then, these initial statistics will be aggregated into different time intervals, and we create samples in with a 60-min wide sliding window. The first half of the window (30 mins) will be the input to the model, and the second 30 mins will be used to construct labels. Since we will have different tasks, these labels are also not aggregated for now. It will be done in the dataset class.

```
python scripts/data/simbarca/extract_samples.py
```

The script sim_vehicle_traj.py wraps up the Aimsun simulation, and the two scripts above (no setting generation).

```
python scripts/data/simbarca/sim_vehicle_traj.py
```

### Visualize

This script provides some visualization examples

```
python scripts/data/simbarca/draw_things.py
```
