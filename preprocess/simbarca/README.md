## How to create SimBarca dataset

This file describes how to create the SimBarca dataset from the very beginning. 
For using the dataset, there is no need to run the commands below, continue only when you want to start from **absolute scratch**.

### 0. Environment

The raw vehicle trajectories are generated from the traffic simulation software [Aimsun](https://www.aimsun.com/), and then processed using python. 

**It is recommended to create a separate conda environment for creating and processing SimBarca, as my code strictly depends on pandarallel and pandas 2.2.0. And they won't be used after the dataset is created.**

Many datasets use `.h5` files to store raw data, and preprocessing `.h5` files with pandas [requires PyTables](https://pandas.pydata.org/docs/getting_started/install.html#dependencies), one can install it individually or install all dependencies of pandas at once.

```
python -m pip install pandas[all]==2.2.0 pandarallel
```

### 1. Read Network Structure

To obtain metadata from Aimsun

1. Open Aimsun and open the network model for Barcelona (provided on request)
2. In the project tree on the right, navigate to Scripts, right click to create a new empty script
3. Open the new script, copy read_road_graph.py and paste to the script section under aimsun project window.
4. Click `execute` at the bottom and then OK.

The road segments need to be clustered and assigned to grids for regional prediction and drone flight scheduling. 

```
python preprocess/simbarca/group_selection.py
```

### 2. Generate Simulation Settings

The simulation experiments will be run with different random seeds, and random augmentations will be applied to the traffic demand.

These randomness settings are generated by augmentations to the original demand matrix.

```
python preprocess/simbarca/gen_exp_settings.py 
```

### 3. Add API to Simulation

The vehicle trajectories are exported using `Aimsun_API.py` please add it to the simulation in Aimsun.

Go to project panel, expand scenarios and then double-click a scenario, select Aimsun Next APIs, and click `Add` and OK.

If the API file is moved, the path settings in Aimsun should also be changed.

Then, the simulation setup is ready.

### 4. Run Wrapper Script

The workflow is wrapped in this script, and it literally does three jobs: run simulation, compute per-time-step statistics, aggregate statistics. See the comments and doc-strings in the script for details.

```
python preprocess/simbarca/sim_vehicle_traj.py
```

#### Obtain Per-time-step Statistics

First, the trajectories (positions over time) will be used to compute initial statistics for all sections (road segments) at each time step.

```
python preprocess/simbarca/time_series_from_traj.py
```

Please look at the script comments for details.

#### Aggregate Statistics

Then, these initial statistics will be aggregated into different time intervals, and we create samples in with a 60-min wide sliding window. 
The first half of the window (30 mins) will be the input to the model, and the second 30 mins will be used to construct labels. 
Since we will have different tasks, these labels are also not aggregated for now. It will be done in the dataset class.

```
python preprocess/simbarca/extract_samples.py
```

### 5. Final Steps

The script `choose_train_test.py` will do a train-test split, and the region definitions are created by `group_sections.py`.
Due to randomness in the libraries, one may not get exactly the settings as the paper.

